<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<link rel="stylesheet" href="tsn_catalog_fichiers/ol.css"
	type="text/css">
<style>
.row {
	clear: both;
	margin: 10px;
	position: absolute;
	padding: 10px;
	height: 100%;
}

#wms_request {
	float: left;
	margin-left: 50px;
	left: 10px;
	width: 700px;
	height: 100px;
}

.column {
	float: left;
	padding: 10px;
	margin: 40px;
}

.ol-zoom {
	top: 52px;
}

.ol-toggle-options {
	z-index: 1000;
	background: rgba(255, 255, 255, 0.4);
	border-radius: 4px;
	padding: 2px;
	position: absolute;
	left: 8px;
	top: 8px;
}

#updateFilterButton, #resetFilterButton {
	height: 22px;
	width: 22px;
	text-align: center;
	text-decoration: none !important;
	line-height: 22px;
	margin: 1px;
	font-family: 'Lucida Grande', Verdana, Geneva, Lucida, Arial, Helvetica,
		sans-serif;
	font-weight: bold !important;
	background: rgba(0, 60, 136, 0.5);
	color: white !important;
	padding: 2px;
}

.ol-toggle-options a {
	background: rgba(0, 60, 136, 0.5);
	color: white;
	display: block;
	font-family: 'Lucida Grande', Verdana, Geneva, Lucida, Arial, Helvetica,
		sans-serif;
	font-size: 19px;
	font-weight: bold;
	height: 22px;
	line-height: 11px;
	margin: 1px;
	padding: 0;
	text-align: center;
	text-decoration: none;
	width: 22px;
	border-radius: 2px;
}

.ol-toggle-options a:hover {
	color: #fff;
	text-decoration: none;
	background: rgba(0, 60, 136, 0.7);
}

body {
	font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
	font-size: small;
}

iframe {
	width: 100%;
	height: 250px;
	border: none;
}
/* Toolbar styles */
#toolbar {
	position: relative;
	padding: 10px;
	margin: 10px;
}

#toolbar ul {
	list-style: none;
	padding: 0;
	margin: 0;
}

#toolbar ul li {
	float: left;
	padding-right: 1em;
	padding-bottom: 0.5em;
}

#toolbar ul li a {
	font-weight: bold;
	font-size: smaller;
	vertical-align: middle;
	color: black;
	text-decoration: none;
}

#toolbar ul li a:hover {
	text-decoration: underline;
}

#toolbar ul li * {
	vertical-align: middle;
}

#map {
	clear: both;
	position: relative;
	width: 600px;
	height: 500px;
	border: 1px solid black;
	float: right;
	clear: both;
	height: 500px;
}

#wrapper {
	width: 512px;
}

#location {
	float: right;
}
/* Styles used by the default GetFeatureInfo output, added to make IE happy */
table.featureInfo, table.featureInfo td, table.featureInfo th {
	border: 1px solid #ddd;
	border-collapse: collapse;
	margin: 0;
	padding: 0;
	font-size: 90%;
	padding: .2em .1em;
}

table.featureInfo th {
	padding: .2em .2em;
	font-weight: bold;
	background: #eee;
}

table.featureInfo td {
	background: #fff;
}

table.featureInfo tr.odd td {
	background: #eee;
}

table.featureInfo caption {
	text-align: left;
	font-size: 100%;
	font-weight: bold;
	padding: .2em .2em;
}

.hide {
	display: none;
}
</style>
<script src="tsn_catalog_fichiers/ol.js" type="text/javascript"></script>
<title>TSN Units - Catalog Service</title>
</head>
<body>
	<div id="toolbar" style="display: block;">
		<ul>
			<li class="hide"><a>WMS version:</a> <select
				id="wmsVersionSelector" onchange="setWMSVersion(value)">
					<option value="1.1.1" selected="selected">1.1.1</option>
					<option value="1.3.0">1.3.0</option>
			</select></li>
			<li class="hide"><a>Tiling:</a> <select id="tilingModeSelector"
				onchange="setTileMode(value)">
					<option value="untiled" selected="selected">Single tile</option>
					<option value="tiled">Tiled</option>
			</select></li>
			<li class="hide"><a>Antialias:</a> <select
				id="antialiasSelector" onchange="setAntialiasMode(value)">
					<option value="full" selected="selected">Full</option>
					<option value="text">Text only</option>
					<option value="none">Disabled</option>
			</select></li>
			<li class="hide"><a>Format:</a> <select id="imageFormatSelector"
				onchange="setImageFormat(value)">
					<option value="image/png" selected="selected">PNG 24bit</option>
					<option value="image/png8">PNG 8bit</option>
					<option value="image/gif">GIF</option>
					<option id="jpeg" value="image/jpeg">JPEG</option>
					<option id="jpeg-png" value="image/vnd.jpeg-png">JPEG-PNG</option>
			</select></li>
			<li class="hide"><a>Styles:</a> <select id="imageFormatSelector"
				onchange="setStyle(value)">
					<option value="" selected="selected">Default</option>
			</select></li>
			<li class="hide"><a>Width/Height:</a> <select id="widthSelector"
				onchange="setWidth(value)">
					<!--
             These values come from a statistics of the viewable area given a certain screen area
             (but have been adapted a litte, simplified numbers, added some resolutions for wide screen)
             You can find them here: http://www.evolt.org/article/Real_World_Browser_Size_Stats_Part_II/20/2297/
             -->
					<option value="auto" selected="selected">Auto</option>
					<option value="600">600</option>
					<option value="750">750</option>
					<option value="950">950</option>
					<option value="1000">1000</option>
					<option value="1200">1200</option>
					<option value="1400">1400</option>
					<option value="1600">1600</option>
					<option value="1900">1900</option>
			</select> <select id="heigthSelector" onchange="setHeight(value)">
					<option value="auto" selected="selected">Auto</option>
					<option value="300">300</option>
					<option value="400">400</option>
					<option value="500">500</option>
					<option value="600">600</option>
					<option value="700">700</option>
					<option value="800">800</option>
					<option value="900">900</option>
					<option value="1000">1000</option>
			</select></li>
			<li><b>Filters:</b></li>
			<li><a>TSN version:</a> <select id="filtre_tsn_version">
					<option value="">-- select an option --</option>
					<option value="1999">NUTS 1999</option>
					<option value="2003">NUTS 2003</option>
					<option value="2006">NUTS 2006</option>
					<option value="2010">NUTS 2010</option>
			</select></li>

			<li><a>TSN level:</a> <select id="filtre_tsn_level">
					<option value="">-- select an option --</option>
					<option value="-1">NUTS Level Territory</option>
					<option value="0">NUTS Level 0 (states regions)</option>
					<option value="1">NUTS Level 1 (major socio-economic
						regions)</option>
					<option value="2">NUTS Level 2 (basic regions)</option>
					<option value="3">NUTS Level 3 (small regions )</option>
			</select></li>
			<li><select id="filterType">
					<option value="fid" selected="selected">Unit Version ID</option>
					<option value="id_unit_nomenclature">Unit NUTS ID</option>
					<option value="unit_name">Unit name</option>
					<!-- 					<option value="idnomenclature_version">TSN version</option> -->
					<!-- 					<option value="level">TSN level</option> -->
					<!-- 					<option value="cql">CQL</option> -->
					<!-- unit_name ='Mid-West' -->
					<!-- 					<option value="ogc">OGC</option> -->

			</select> <input size="80" id="filter" value="" type="text"> <a
				id="updateFilterButton" href="#" onclick="updateFilter()"
				title="Apply filter">Apply</a> <a id="resetFilterButton" href="#"
				onclick="resetFilter()" title="Reset filter">Reset</a></li>
		</ul>
	</div>
	<div class="row">
		<div class="column">
			<div id="map">
				<div class="ol-toggle-options ol-unselectable">
					<a title="Toggle options toolbar" onclick="toggleControlPanel()"
						href="#toggle">...</a>
				</div>
				<!-- 		<div class="ol-viewport" -->
				<!-- 			style="position: relative; overflow: hidden; width: 100%; height: 100%; touch-action: none;"> -->
				<!-- 			<canvas style="width: 100%; height: 100%;" class="ol-unselectable" -->
				<!-- 				width="1024" height="874"> </canvas> -->
				<!-- 			<div class="ol-overlaycontainer"></div> -->
				<!-- 			<div class="ol-overlaycontainer-stopevent"> -->
				<!-- 				<div class="ol-zoom ol-unselectable ol-control"> -->
				<!-- 					<button class="ol-zoom-in" type="button" title="Zoom in">+</button> -->
				<!-- 					<button class="ol-zoom-out" type="button" title="Zoom out">−</button> -->
				<!-- 				</div> -->
				<!-- 				<div class="ol-rotate ol-unselectable ol-control ol-hidden"> -->
				<!-- 					<button class="ol-rotate-reset" type="button" -->
				<!-- 						title="Reset rotation"> -->
				<!-- 						<span class="ol-compass" style="transform: rotate(0rad);">⇧</span> -->
				<!-- 					</button> -->
				<!-- 				</div> -->
				<!-- 			</div> -->
				<!-- 		</div> -->
			</div>
		</div>
		<div class="column">
			<div id="wrapper">
				<div id="location">
					<div class="custom-mouse-position">&nbsp;</div>
				</div>
				<div id="scale">Scale = 1 : 4M</div>
				<div id="nodelist">
					<iframe seamless="" src=""></iframe>
				</div>
			</div>
		</div>
		<div id="wms_request"></div>
		<script type="text/javascript">
			var pureCoverage = false;
			// if this is just a coverage or a group of them, disable a few items,
			// and default to jpeg format
			var format = 'image/png';
			var bounds = [ 2641758.46992888, 1415601.8557804, 7313157.28587087,
					5411284.00418423 ];
			if (pureCoverage) {
				document.getElementById('antialiasSelector').disabled = true;
				document.getElementById('jpeg').selected = true;
				format = "image/jpeg";
			}

			var supportsFiltering = true;
			if (!supportsFiltering) {
				document.getElementById('filterType').disabled = true;
				document.getElementById('filter').disabled = true;
				document.getElementById('updateFilterButton').disabled = true;
				document.getElementById('resetFilterButton').disabled = true;
			}

			var mousePositionControl = new ol.control.MousePosition({
				className : 'custom-mouse-position',
				target : document.getElementById('location'),
				coordinateFormat : ol.coordinate.createStringXY(5),
				undefinedHTML : '&nbsp;'
			});
			var untiled = new ol.layer.Image({
				source : new ol.source.ImageWMS({
					ratio : 1,
					url : 'http://127.0.0.1:8080/geoserver/nuts/wms',
					params : {
						'FORMAT' : format,
						'VERSION' : '1.1.1',
						STYLES : '',
						LAYERS : 'nuts:unit_version',
					}
				})
			});
			var tiled = new ol.layer.Tile({
				visible : false,
				source : new ol.source.TileWMS({
					url : 'http://127.0.0.1:8080/geoserver/nuts/wms',
					params : {
						'FORMAT' : format,
						'VERSION' : '1.1.1',
						tiled : true,
						STYLES : '',
						LAYERS : 'nuts:unit_version',
						tilesOrigin : 2641758.46992888 + "," + 1415601.8557804
					}
				})
			});
			var osm_based = new ol.layer.Tile(
					{
						visible : true,
						source : new ol.source.XYZ(
								{
									url : 'http://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
								})
					});
			//source : new ol.source.XYZ({ url: 'http://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png' })
			//source: new ol.source.OSM()

			var projection = new ol.proj.Projection({
				code : 'EPSG:3857',
				units : 'm',
				axisOrientation : 'neu',
				global : false
			});
			var map = new ol.Map({
				controls : ol.control.defaults({
					attribution : false
				}).extend([ mousePositionControl ]),
				target : 'map',
				layers : [ osm_based, untiled, tiled ],
				view : new ol.View({
					projection : projection,
					zoom : 6
				})
			});
			map
					.getView()
					.on(
							'change:resolution',
							function(evt) {
								var resolution = evt.target.get('resolution');
								var units = map.getView().getProjection()
										.getUnits();
								var dpi = 25.4 / 0.28;
								var mpu = ol.proj.METERS_PER_UNIT[units];
								var scale = resolution * mpu * 39.37 * dpi;
								if (scale >= 9500 && scale <= 950000) {
									scale = Math.round(scale / 1000) + "K";
								} else if (scale >= 950000) {
									scale = Math.round(scale / 1000000) + "M";
								} else {
									scale = Math.round(scale);
								}
								document.getElementById('scale').innerHTML = "Scale = 1 : "
										+ scale;
							});
			map.getView().fit(bounds, map.getSize());
			map
					.on(
							'singleclick',
							function(evt) {
								document.getElementById('nodelist').innerHTML = "Loading... please wait...";
								var xmlhttp;
								if (window.XMLHttpRequest) {
									// code for IE7+, Firefox, Chrome, Opera, Safari
									xmlhttp = new XMLHttpRequest();
								} else {
									// code for IE6, IE5
									xmlhttp = new ActiveXObject(
											"Microsoft.XMLHTTP");
								}
								var view = map.getView();
								var method = "GET";
								var viewResolution = view.getResolution();
								var source = untiled.get('visible') ? untiled
										.getSource() : tiled.getSource();
								var url = source.getGetFeatureInfoUrl(
										evt.coordinate, viewResolution, view
												.getProjection(), {
											'INFO_FORMAT' : 'text/html',
											'FEATURE_COUNT' : 50
										});

								if (url) {
									xmlhttp.onload = function() {
										var text = xmlhttp.responseText;
										var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
										var text1 = text.replace(exp,
												"<a href='$1'>$1</a>");
										document.getElementById("nodelist").innerHTML = text1;
										document.getElementById("wms_request").innerHTML = "Request: <a href='"+url+"'>"
												+ url + "</a>";

										//document.getElementById('nodelist').innerHTML = xmlhttp.responseText;

									}
									// 			 document.getElementById('nodelist').innerHTML = xmlhttp.responseText;
									//				 '<iframe seamless src="' + url + '"></iframe>';
								}
								xmlhttp.open(method, url, true);
								xmlhttp.send();

							});

			// sets the chosen WMS version
			function setWMSVersion(wmsVersion) {
				map.getLayers().forEach(function(lyr) {
					lyr.getSource().updateParams({
						'VERSION' : wmsVersion
					});
				});
				if (wmsVersion == "1.3.0") {
					origin = bounds[1] + ',' + bounds[0];
				} else {
					origin = bounds[0] + ',' + bounds[1];
				}
				tiled.getSource().updateParams({
					'tilesOrigin' : origin
				});
			}

			// Tiling mode, can be 'tiled' or 'untiled'
			function setTileMode(tilingMode) {
				if (tilingMode == 'tiled') {
					untiled.set('visible', false);
					tiled.set('visible', true);
				} else {
					tiled.set('visible', false);
					untiled.set('visible', true);
				}
			}

			function setAntialiasMode(mode) {
				map.getLayers().forEach(function(lyr) {
					lyr.getSource().updateParams({
						'FORMAT_OPTIONS' : 'antialias:' + mode
					});
				});
			}

			// changes the current tile format
			function setImageFormat(mime) {
				map.getLayers().forEach(function(lyr) {
					lyr.getSource().updateParams({
						'FORMAT' : mime
					});
				});
			}

			function setStyle(style) {
				map.getLayers().forEach(function(lyr) {
					lyr.getSource().updateParams({
						'STYLES' : style
					});
				});
			}

			function setWidth(size) {
				var mapDiv = document.getElementById('map');
				var wrapper = document.getElementById('wrapper');

				if (size == "auto") {
					// reset back to the default value
					mapDiv.style.width = null;
					wrapper.style.width = null;
				} else {
					mapDiv.style.width = size + "px";
					wrapper.style.width = size + "px";
				}
				// notify OL that we changed the size of the map div
				map.updateSize();
			}

			function setHeight(size) {
				var mapDiv = document.getElementById('map');
				if (size == "auto") {
					// reset back to the default value
					mapDiv.style.height = null;
				} else {
					mapDiv.style.height = size + "px";
				}
				// notify OL that we changed the size of the map div
				map.updateSize();
			}

			function updateFilter() {
				if (!supportsFiltering) {
					return;
				}

				var filterTsnVersion = document
						.getElementById('filtre_tsn_version').value;
				var filterTsnLevel = document
						.getElementById('filtre_tsn_level').value;

				var filterType = document.getElementById('filterType').value;
				var filter = document.getElementById('filter').value;
				// by default, reset all filters
				var filterParams = {
					'FILTER' : null,
					'CQL_FILTER' : null,
					'FEATUREID' : null
				};

				if (filterTsnVersion !== null && filterTsnVersion !== "") {
					filterParams["CQL_FILTER"] = "idnomenclature_version ='"
							+ filterTsnVersion + "'";
					if (filterTsnLevel !== null  && filterTsnLevel !== "") { //filterTsnVersion AND filterTsnLevel are not null
						filterParams["CQL_FILTER"] += " AND level ='"
								+ filterTsnLevel + "'";

					}
				} else { //filterTsnVersion is null
					if (filterTsnLevel !== null && filterTsnLevel !== "") {
						filterParams["CQL_FILTER"] = "level ='"
								+ filterTsnLevel + "'";
					}
				}

				if (filter.replace(/^\s\s*/, '').replace(/\s\s*$/, '') != "") {
					if (filterTsnVersion !== "" || filterTsnLevel !== "") {
						if (filterType == "unit_name") {
							filterParams["CQL_FILTER"] += " AND unit_name ='"
									+ filter + "'";
						}
						if (filterType == "id_unit_nomenclature") {
							filterParams["CQL_FILTER"] = "id_unit_nomenclature ='"
									+ filter + "'";
						}
					} if (filterTsnVersion == "" && filterTsnLevel == "") {
						if (filterType == "unit_name") {
							filterParams["CQL_FILTER"] = "unit_name ='"
									+ filter + "'";
						}
						
						if (filterType == "id_unit_nomenclature") {
							filterParams["CQL_FILTER"] = "id_unit_nomenclature ='"
									+ filter + "'";
						}
					}
					if (filterType == "fid") {
						filterParams["FEATUREID"] = filter;
					}
					if (filterType == "cql") {
						filterParams["CQL_FILTER"] = filter;
					}
					if (filterType == "ogc") {
						filterParams["FILTER"] = filter;
					}

				}
				// merge the new filter definitions
				map
						.getLayers()
						.forEach(
								function(lyr) {
									if (lyr.getSource() instanceof ol.source.ImageWMS
											|| lyr.getSource() instanceof ol.source.TileWMS) {
										lyr.getSource().updateParams(
												filterParams);
									}
								});
			}

			function resetFilter() {
				if (!supportsFiltering) {
					return;
				}
				document.getElementById('filter').value = "";
				updateFilter();
			}

			// shows/hide the control panel
			function toggleControlPanel() {
				var toolbar = document.getElementById("toolbar");
				if (toolbar.style.display == "none") {
					toolbar.style.display = "block";
				} else {
					toolbar.style.display = "none";
				}
				map.updateSize()
			}
		</script>


	</div>
</body>
</html>